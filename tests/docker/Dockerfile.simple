# Pi Gateway Docker Test Environment (Simple Version)
# ARM64 container for cross-platform Pi Gateway testing without systemd

FROM debian:bookworm-slim

# Install basic system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    sudo \
    openssh-server \
    procps \
    net-tools \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create pi user with sudo access
RUN useradd -m -s /bin/bash pi && \
    echo "pi:raspberry" | chpasswd && \
    usermod -aG sudo pi && \
    echo "pi ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create alternate mock hardware file
RUN mkdir -p /tmp/mock-pi && \
    echo "Raspberry Pi 4 Model B Rev 1.4" > /tmp/mock-pi/model

# Configure SSH
RUN mkdir -p /var/run/sshd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#Port 22/Port 22/' /etc/ssh/sshd_config

# Create Pi Gateway test directory
WORKDIR /home/pi/pi-gateway

# Copy Pi Gateway scripts
COPY . /home/pi/pi-gateway/
RUN chown -R pi:pi /home/pi/pi-gateway && \
    chmod +x /home/pi/pi-gateway/scripts/*.sh

# Create mock systemctl for service testing
RUN echo '#!/bin/bash' > /usr/local/bin/systemctl && \
    echo 'case "$1" in' >> /usr/local/bin/systemctl && \
    echo '  "start"|"stop"|"enable"|"disable") echo "Mock: systemctl $*"; exit 0 ;;' >> /usr/local/bin/systemctl && \
    echo '  "is-active"|"is-enabled") echo "active"; exit 0 ;;' >> /usr/local/bin/systemctl && \
    echo '  "status") echo "â— $2 - Mock Service"; echo "   Active: active (running)"; exit 0 ;;' >> /usr/local/bin/systemctl && \
    echo '  *) /bin/systemctl "$@" ;;' >> /usr/local/bin/systemctl && \
    echo 'esac' >> /usr/local/bin/systemctl && \
    chmod +x /usr/local/bin/systemctl

# Expose SSH port
EXPOSE 22

# Set up environment
ENV HOME=/home/pi
ENV USER=pi
ENV MOCK_MODE=true
ENV PI_GATEWAY_TESTING=true
ENV MOCK_PI_MODEL="Raspberry Pi 4 Model B Rev 1.4"
ENV MOCK_PI_MEMORY_MB=4096
ENV MOCK_PI_STORAGE_GB=32
ENV MOCK_PI_CPU_CORES=4

# Start SSH daemon and keep container running
CMD ["/usr/sbin/sshd", "-D"]